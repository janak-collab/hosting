<?php
namespace App\Controllers;

use App\Models\Role;

class DashboardController extends BaseController {
    private $roleModel;
    
    public function __construct() {
        $this->roleModel = new Role();
    }
    
    public function index() {
        // Get current user
        $username = $_SERVER['PHP_AUTH_USER'] ?? 'guest';
        
        // Get user's role
        $userRole = $this->roleModel->getUserRole($username);
        
        // Route to appropriate dashboard
        switch($userRole) {
            case 'front_desk':
                return $this->frontDeskDashboard();
            case 'clinical':
                return $this->clinicalDashboard();
            case 'billing':
                return $this->billingDashboard();
            case 'admin':
                return $this->adminDashboard();
            default:
                return $this->frontDeskDashboard();
        }
    }
    
    private function frontDeskDashboard() {
        $quickActions = [
            ['title' => 'Phone Note', 'icon' => 'ğŸ“', 'url' => '/phone-note', 'color' => '#4CAF50'],
            ['title' => 'Check In Patient', 'icon' => 'âœ“', 'url' => '/patient/checkin', 'color' => 
'#2196F3'],
            ['title' => 'Schedule Appointment', 'icon' => 'ğŸ“…', 'url' => '/scheduling', 'color' => 
'#FF9800'],
            ['title' => 'Patient Forms', 'icon' => 'ğŸ“„', 'url' => '/forms/patient', 'color' => '#9C27B0']
        ];
        
        $sections = [
            'daily_tasks' => [
                'title' => 'Daily Tasks',
                'items' => [
                    ['name' => 'Today\'s Schedule', 'url' => '/schedule/today'],
                    ['name' => 'Check Out Patient', 'url' => '/patient/checkout'],
                    ['name' => 'Payment Receipt', 'url' => '/billing/receipt'],
                    ['name' => 'Message Provider', 'url' => '/messages/provider']
                ]
            ],
            'patient_services' => [
                'title' => 'Patient Services',
                'items' => [
                    ['name' => 'New Patient Registration', 'url' => '/patient/new'],
                    ['name' => 'Update Patient Info', 'url' => '/patient/update'],
                    ['name' => 'Insurance Verification', 'url' => '/insurance/verify'],
                    ['name' => 'Print Forms', 'url' => '/forms']
                ]
            ]
        ];
        
        return $this->view('dashboard/front_desk', [
            'quickActions' => $quickActions,
            'sections' => $sections,
            'userRole' => 'Front Desk'
        ]);
    }
    
    private function clinicalDashboard() {
        $quickActions = [
            ['title' => 'Procedure Notes', 'icon' => 'ğŸ’‰', 'url' => '/clinical/procedures', 'color' => 
'#f26522'],
            ['title' => 'Vital Signs', 'icon' => 'â¤ï¸', 'url' => '/clinical/vitals', 'color' => '#E91E63'],
            ['title' => 'Patient Education', 'icon' => 'ğŸ“š', 'url' => '/clinical/education', 'color' => 
'#3F51B5'],
            ['title' => 'Lab Orders', 'icon' => 'ğŸ§ª', 'url' => '/clinical/labs', 'color' => '#009688']
        ];
        
        $sections = [
            'procedures' => [
                'title' => 'Procedures',
                'items' => [
                    ['name' => 'Office Injections', 'url' => '/clinical/injections'],
                    ['name' => 'CSC Procedures', 'url' => '/procedures/csc'],
                    ['name' => 'LSC Procedures', 'url' => '/procedures/lsc'],
                    ['name' => 'Procedure Documentation', 'url' => '/clinical/documentation']
                ]
            ],
            'patient_care' => [
                'title' => 'Patient Care',
                'items' => [
                    ['name' => 'Treatment Plans', 'url' => '/clinical/treatment-plans'],
                    ['name' => 'Medication Management', 'url' => '/clinical/medications'],
                    ['name' => 'Follow-up Care', 'url' => '/clinical/followup'],
                    ['name' => 'Referrals', 'url' => '/clinical/referrals']
                ]
            ]
        ];
        
        return $this->view('dashboard/clinical', [
            'quickActions' => $quickActions,
            'sections' => $sections,
            'userRole' => 'Clinical Staff'
        ]);
    }
    
    private function billingDashboard() {
        // Similar structure for billing dashboard
        $quickActions = [
            ['title' => 'New Claim', 'icon' => 'ğŸ’°', 'url' => '/billing/new-claim', 'color' => '#4CAF50'],
            ['title' => 'Payment Entry', 'icon' => 'ğŸ’³', 'url' => '/billing/payment', 'color' => '#2196F3'],
            ['title' => 'Denials', 'icon' => 'âŒ', 'url' => '/billing/denials', 'color' => '#F44336'],
            ['title' => 'Reports', 'icon' => 'ğŸ“Š', 'url' => '/billing/reports', 'color' => '#FF9800']
        ];
        
        return $this->view('dashboard/billing', [
            'quickActions' => $quickActions,
            'userRole' => 'Billing Staff'
        ]);
    }
    
    private function adminDashboard() {
        // Admin sees everything
        $quickActions = [
            ['title' => 'User Management', 'icon' => 'ğŸ‘¥', 'url' => '/admin/users', 'color' => '#795548'],
            ['title' => 'System Settings', 'icon' => 'âš™ï¸', 'url' => '/admin/settings', 'color' => 
'#607D8B'],
            ['title' => 'Reports', 'icon' => 'ğŸ“ˆ', 'url' => '/admin/reports', 'color' => '#FF5722'],
            ['title' => 'IT Tickets', 'icon' => 'ğŸ«', 'url' => '/admin/tickets', 'color' => '#9E9E9E']
        ];
        
        return $this->view('dashboard/admin', [
            'quickActions' => $quickActions,
            'userRole' => 'Administrator'
        ]);
    }
}
